# .github/workflows/ci-cd.yml

name: Pipeline CI/CD com Python API

on:
  push:
    branches: [ "main" ] # Aciona a pipeline no push para a branch 'main'
  pull_request:
    branches: [ "main" ] # Aciona em Pull Requests para 'main'

jobs:
  # ===================================================
  # 1. JOB DE CI (INTEGRA√á√ÉO CONT√çNUA) - BUILD E TESTE
  # ===================================================
  build-and-test:
    runs-on: ubuntu-latest # Executa em uma m√°quina virtual Linux

    steps:
      - name: 1. Checkout do C√≥digo
        uses: actions/checkout@v4

      - name: 2. Configurar Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # Acelera a instala√ß√£o de depend√™ncias

      - name: 3. Instalar Depend√™ncias (incluindo pytest e gunicorn)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest # Garante que o framework de teste est√° instalado

      - name: 4. Executar Testes Unit√°rios (Os 3 tipos)
        # Comando que roda seu arquivo test_app.py
        run: pytest test_app.py
        
      # Armazena o c√≥digo como um artefato, s√≥ se os testes passarem
      - name: 5. Upload do Artefato
        uses: actions/upload-artifact@v4
        with:
          name: api-artifact
          path: . 

  # ===================================================
  # 2. JOB DE CD (ENTREGA CONT√çNUA) - DEPLOY NO HEROKU
  # ===================================================
  deploy:
    needs: build-and-test # Este job S√ì roda se o 'build-and-test' for BEM-SUCEDIDO
    runs-on: ubuntu-latest
    environment: Production # Identifica o ambiente de produ√ß√£o
    
    steps:
      - name: 1. Baixar o Artefato
        uses: actions/download-artifact@v4
        with:
          name: api-artifact

      - name: 2. Deploy no Heroku 
        uses: akhileshns/heroku-deploy@v3.12.12
        with:
          # Vari√°veis Secretas que voc√™ deve configurar no GitHub
          heroku_email: ${{ secrets.HEROKU_EMAIL }} 
          heroku_api_key: ${{ secrets.HRKU-AAhuLAPAE8FoCAwoveJGRxUBAfKrBTQYGLDN-uBb89kQ_____ww5XTYGyBb- }}
          # üö® Substitua pelo nome do seu app no Heroku
          heroku_app_name: "Desafio Final" 
          remote_branch: main # Branch de onde o c√≥digo ser√° implantado