# .github/workflows/ci-cd.yml

name: Pipeline CI/CD com Python API

on:
  push:
    branches: [ "main" ] # Aciona a pipeline no push para a branch 'main'
  pull_request:
    branches: [ "main" ] # Aciona em Pull Requests para 'main'

jobs:
  # ===================================================
  # 1. JOB DE CI (INTEGRAÇÃO CONTÍNUA) - BUILD E TESTE
  # ===================================================
  build-and-test:
    runs-on: ubuntu-latest # Executa em uma máquina virtual Linux

    steps:
      - name: 1. Checkout do Código
        uses: actions/checkout@v4

      - name: 2. Configurar Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # Acelera a instalação de dependências

      - name: 3. Instalar Dependências (incluindo pytest e gunicorn)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest # Garante que o framework de teste está instalado

      - name: 4. Executar Testes Unitários (Os 3 tipos)
        # Comando que roda seu arquivo test_app.py
        run: pytest test_app.py
        
      # Armazena o código como um artefato, só se os testes passarem
      - name: 5. Upload do Artefato
        uses: actions/upload-artifact@v4
        with:
          name: api-artifact
          path: . 

  # ===================================================
  # 2. JOB DE CD (ENTREGA CONTÍNUA) - DEPLOY NO HEROKU
  # ===================================================
  deploy:
    needs: build-and-test # Este job SÓ roda se o 'build-and-test' for BEM-SUCEDIDO
    runs-on: ubuntu-latest
    environment: Production # Identifica o ambiente de produção
    
    steps:
      - name: 1. Checkout do Código
        uses: actions/checkout@v3

      - name: 2. Baixar o Artefato
        uses: actions/download-artifact@v4
        with:
          name: api-artifact

      - name: 3. Deploy no Heroku
        uses: akhileshns/heroku-deploy@v3.12.12
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
          branch: main # CORREÇÃO: Usar 'branch' em vez de 'remote_branch'